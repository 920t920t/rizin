---
import type { Bout, VoteCounts } from '@lib/types';
import VoteWidget from './VoteWidget.astro';
const { bouts, votes } = Astro.props as { bouts: Bout[]; votes: VoteCounts };
---
<section aria-labelledby="featured-heading" style="margin-top:16px;">
  <h2 id="featured-heading">注目マッチアップ</h2>
  <div style="display:flex;gap:8px;align-items:center;margin:8px 0 12px;">
    <label class="muted" for="sort-bouts">並び替え:</label>
    <select id="sort-bouts" class="card" style="padding:8px;">
      <option value="popular">人気順（投票多→少）</option>
      <option value="pair">組み合わせ（キー昇順）</option>
    </select>
    <span id="bouts-count" class="muted" style="font-size:12px;" aria-live="polite"></span>
  </div>
  <div id="bouts-list" class="grid" role="list" aria-label="注目マッチアップ">
    {(bouts).map((b) => {
      const key = [b.fighterId, b.opponentId].sort().join('_');
      const initial = votes[key] ?? 0;
      return (
        <div class="card" role="listitem" data-key={key} data-votes={String(initial)}>
          <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div>
              <div><strong>{b.fighterId}</strong> vs <strong>{b.opponentId}</strong></div>
              <div class="muted" style="font-size:12px;">{b.event ?? ''} {b.notes ?? ''}</div>
            </div>
            <VoteWidget fighterId={b.fighterId} opponentId={b.opponentId} initialCount={initial} />
          </div>
        </div>
      );
    })}
  </div>

  <div style="margin-top:12px;">
    <button id="export-votes" class="btn">ローカル投票をエクスポート</button>
  </div>
</section>

<script>
  // sort toggle
  const list = document.getElementById('bouts-list');
  const select = document.getElementById('sort-bouts');
  const count = document.getElementById('bouts-count');
  const items = () => Array.from(list?.children || []);

  function applySort() {
    const mode = (select instanceof HTMLSelectElement) ? select.value : 'popular';
    const els = items();
    const frag = document.createDocumentFragment();
    els.sort((a, b) => {
      if (mode === 'pair') {
        return (a.getAttribute('data-key') || '').localeCompare((b.getAttribute('data-key') || ''));
      }
      const av = parseInt(a.getAttribute('data-votes') || '0', 10);
      const bv = parseInt(b.getAttribute('data-votes') || '0', 10);
      return bv - av; // popular: desc
    }).forEach(el => frag.appendChild(el));
    if (list) list.appendChild(frag);
    if (count) count.textContent = `${els.length}件`;
  }

  select?.addEventListener('change', applySort);
  applySort();

  function collectVotes() {
    const votes = {};
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (!k) continue;
      if (k.startsWith('vote:delta:')) {
        const key = k.replace('vote:delta:', '');
        const val = parseInt(localStorage.getItem(k) || '0', 10) || 0;
        if (val > 0) votes[key] = val;
      }
    }
    return {
      exportedAt: new Date().toISOString(),
      cooldownMs: 24 * 60 * 60 * 1000,
      votes
    };
  }

  function downloadJSON(obj, filename) {
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  document.getElementById('export-votes')?.addEventListener('click', () => {
    const data = collectVotes();
    downloadJSON(data, 'local_votes.json');
  });
</script>
